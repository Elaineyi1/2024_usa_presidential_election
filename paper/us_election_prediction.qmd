---
title: ""
author: 
  - Boxuan Yi
format: 
  pdf:
    documentclass: article
    geometry: margin = 1in
    abstract: ""
date: "17 October 2024"
date-format: "D MMMM YYYY"
number-sections: true
thanks: "Code and data in this analysis is available at: https://github.com/Elaineyi1/2024_usa_presidential_election"
toc: true
bibliography: references.bib
---
# Introduction
```{r}
#| include: false
library(dplyr)
library(tidyverse)
library(here)
library(janitor)
library(knitr)
library(readr)
library(modelsummary)
library(ggplot2)
library(statebins)
library(arrow)
```

```{r}
#| include: false
poll_cleaned <- read_parquet(here::here("..", "inputs", "data", "president_polls_cleaned.parquet"))

poll_harris_cleaned <- poll_cleaned |> filter(candidate_name == "Kamala Harris")

poll_harris_national_cleaned <- read_parquet(here::here("..", "inputs", "data_with_prediction", "national_prediction.parquet"))
poll_harris_state_cleaned <- read_parquet(here::here("..", "inputs", "data_with_prediction", "state_prediction.parquet"))
```

# Data
```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-numeric_grade
#| fig-cap: Distribution of Numeric Grades for State and National Surveys
poll_cleaned |> 
  ggplot(aes(x = state_or_national, y = numeric_grade)) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(0, 3, by = 0.5)) +
  labs(x = "State or National Survey",y = "Numeric Grade") +
  theme_classic()
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-sample_size
#| fig-cap: Frequency Distribution of Sample Sizes for State and National Surveys

poll_harris_cleaned |>
  ggplot(aes(x = sample_size, color = state_or_national)) +
  geom_freqpoly() +
  labs(x = "Sample Size",y = "Number of occurrences", color = "National or State Survey") +
  theme_classic() + 
  scale_color_brewer(palette = "Set1")
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: tbl-national
#| tbl-cap: Weighted Average Proportion of Harris Support from National Surveys

poll_harris_national_cleaned |>
  group_by(state) |> 
  summarise(
    Weighted_Avg_Harris_Support = sum(harris_support_ratio * sample_size, na.rm = TRUE) / sum(sample_size, na.rm = TRUE)
  ) |> 
  mutate(
    Weighted_Avg_Harris_Support = round(Weighted_Avg_Harris_Support, 3)) |> 
  rename(
    Survey = state, 
    'Weighted Average Proportion of Harris Support' = Weighted_Avg_Harris_Support
  ) |> 
  kable()
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: tbl-state
#| tbl-cap: Weighted Average Proportion of Harris Support from State Surveys

poll_harris_state_cleaned |> 
  group_by(state) |> 
  summarise(
    Observations = n(),
    Weighted_Avg_Harris_Support = sum(harris_support_ratio * sample_size, na.rm = TRUE) / sum(sample_size, na.rm = TRUE)
  ) |>  
  mutate(
    Weighted_Avg_Harris_Support = round(Weighted_Avg_Harris_Support, 3)) |> 
  rename('Survey State' = state, 'Nubmer of Survey' = Observations, 'Weighted Average Proportion of Harris Support' = Weighted_Avg_Harris_Support) |> 
  kable()
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-state
#| fig-cap: Proportion of Harris Support by State from State Surveys

all_states <- data.frame(
  state = c(
    "Alabama", "Alaska", "Arizona", "Arkansas", "California", 
    "Colorado", "Connecticut", "Delaware", "Florida", "Georgia", 
    "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", 
    "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", 
    "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", 
    "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", 
    "New Mexico", "New York", "North Carolina", "North Dakota", 
    "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", 
    "South Carolina", "South Dakota", "Tennessee", "Texas", 
    "Utah", "Vermont", "Virginia", "Washington", "West Virginia", 
    "Wisconsin", "Wyoming"))

average_support1 <- poll_harris_state_cleaned |>
  group_by(state) |>
  summarise(
    average_harris_support_ratio = sum(harris_support_ratio * sample_size, na.rm = TRUE) / sum(sample_size, na.rm = TRUE),
    .groups = 'drop'
  )

map_data1 <- all_states |>
  left_join(average_support1, by = "state") |>
  mutate(average_harris_support_ratio = ifelse(is.na(average_harris_support_ratio), NA, average_harris_support_ratio)) 

ggplot(map_data1, aes(fill = average_harris_support_ratio, state = state)) + 
  geom_statebins() + 
  scale_fill_gradient2(low = "#971116", high = "#005D94", mid = "white", midpoint = 0.5, na.value = "grey") + 
  theme_classic() +
  theme(axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  labs(fill = "Proportion of Respondents \nSupporting Harris")
```

# Model
$$
\begin{aligned}
y_i | \mu_i & \sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &= \beta_0 + \beta_1 \times \text{Pollster}_i + \beta_2 \times \text{Numeric Grade}_i + \beta_3 \times \text{Days Since End}_i + \beta_4 \times \text{Population}_i \\
\beta_0 & \sim \text{Normal}(0, 2.5) \\
\beta_1 & \sim \text{Normal}(0, 2.5) \\
\beta_2 & \sim \text{Normal}(0, 2.5) \\
\beta_3 & \sim \text{Normal}(0, 2.5) \\
\beta_4 & \sim \text{Normal}(0, 2.5) \\
\sigma & \sim \text{Exponential}(1)
\end{aligned}
$$

where:

- $y_i$ is the dependent variable, representing the proportion of respondents who support Harris
- $\beta_0$ is the intercept term, representing the expected Harris support ratio when all predictors are zero. It follows a prior distribution that is normal with a mean of 0 and a standard deviation of 2.5.
- $\beta_1$, $\beta_2$, $\beta_3$, and $\beta_4$ are the coefficients corresponding to the predictor variables **Pollster**, **Numeric Grade**, **Days Since End**, and **Population**, respectively. **Days Since End** ranges from 0 to 1, showing how recent the survey ended, with 0 meaning the most recent. Each of these coefficients follows a prior distribution that is normal with a mean of 0 and a standard deviation of 2.5.
- The residual standard deviation, $\sigma$, follows an exponential prior with a rate of 1.

```{r}
#| include: false
harris_model <- readRDS(here::here("..", "model", "model.rds"))
```


```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-summary
#| fig-cap: Model Results for Harris Support Based on Pollster, Pollster Quality, Survey Recency, and Survey Population
#| fig-width: 6.4
#| fig-height: 6.6

modelplot(harris_model, conf_level = 0.95, color = 'royalblue3') +
  labs(x = "Harris Support and 95% Confidence Interval")
```

# Results
```{r}
#| message: false
#| echo: false
#| warning: false
#| label: tbl-national_prediction
#| tbl-cap: Predicted Proportion of Harris Support Based on National Surveys

poll_harris_national_cleaned |> 
  group_by(state) |> 
  summarise(
    Weighted_Avg_Harris_Support = sum(predicted_harris_ratio * sample_size, na.rm = TRUE) / sum(sample_size, na.rm = TRUE)) |> 
  rename('National' = state, 'Predicted Proportion of Support For Harris' = Weighted_Avg_Harris_Support) |> 
  kable()
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: tbl-state_prediction
#| tbl-cap: Predicted Proportion of Harris Support Based on State Surveys

poll_harris_state_cleaned |> 
  group_by(state) |> 
  summarise(
    Weighted_Avg_Harris_Support = sum(predicted_harris_ratio * sample_size, na.rm = TRUE) / sum(sample_size, na.rm = TRUE)
  ) |> 
  rename('State' = state, 'Predicted Proportion of Support For Harris' = Weighted_Avg_Harris_Support) |> 
  kable()
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-state_prediction
#| fig-cap: Predicted Proportion of Harris Support by State from State Surveys

all_states <- data.frame(
  state = c(
    "Alabama", "Alaska", "Arizona", "Arkansas", "California", 
    "Colorado", "Connecticut", "Delaware", "Florida", "Georgia", 
    "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", 
    "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", 
    "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", 
    "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", 
    "New Mexico", "New York", "North Carolina", "North Dakota", 
    "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", 
    "South Carolina", "South Dakota", "Tennessee", "Texas", 
    "Utah", "Vermont", "Virginia", "Washington", "West Virginia", 
    "Wisconsin", "Wyoming"))

average_support2 <- poll_harris_state_cleaned |>
  group_by(state) |>
  summarise(
    average_harris_support_ratio2 = sum(predicted_harris_ratio * sample_size, na.rm = TRUE) / sum(sample_size, na.rm = TRUE),
    .groups = 'drop'
  )

map_data2 <- all_states |>
  left_join(average_support2, by = "state") |>
  mutate(average_harris_support_ratio2 = ifelse(is.na(average_harris_support_ratio2), NA, average_harris_support_ratio2)) 

ggplot(map_data2, aes(fill = average_harris_support_ratio2, state = state)) + 
  geom_statebins() + 
  scale_fill_gradient2(low = "#971116", high = "#005D94", mid = "white", midpoint = 0.5, na.value = "grey") + 
  theme_classic() +
  theme(axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  labs(fill = "Proportion of Respondents \nSupporting Harris")
```
# Discussions {#sec-discussions}

# Appendix {#sec-appendix}
## Data Cleaning {#sec-appendix-cleaning}

\newpage
# References
